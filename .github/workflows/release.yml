name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  RAV1E_VERSION: "0.8.1"
  LIBAVIF_VERSION: "1.1.1"

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config

      - name: Download pre-built rav1e
        run: |
          curl -fsSL "https://github.com/xiph/rav1e/releases/download/v${RAV1E_VERSION}/librav1e-${RAV1E_VERSION}-linux-sse4.tar.gz" \
            | sudo tar xz -C /usr/local --strip-components=0
          sudo ldconfig

      - name: Build libavif (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_RAV1E=SYSTEM \
            -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_AOM=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig

      - name: Build renpak
        run: RENPAK_STATIC=1 cargo build --release

      - name: Package
        run: |
          strip target/release/renpak
          tar czf renpak-linux-x86_64.tar.gz -C target/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-linux-x86_64
          path: renpak-linux-x86_64.tar.gz

  build-linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config

      - name: Download pre-built rav1e
        run: |
          curl -fsSL "https://github.com/xiph/rav1e/releases/download/v${RAV1E_VERSION}/librav1e-${RAV1E_VERSION}-linux-aarch64.tar.gz" \
            | sudo tar xz -C /usr/local --strip-components=0
          sudo ldconfig

      - name: Build libavif (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_RAV1E=SYSTEM \
            -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_AOM=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig

      - name: Build renpak
        run: RENPAK_STATIC=1 cargo build --release

      - name: Package
        run: |
          strip target/release/renpak
          tar czf renpak-linux-aarch64.tar.gz -C target/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-linux-aarch64
          path: renpak-linux-aarch64.tar.gz

  build-macos-aarch64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: brew install cmake ninja pkg-config

      - name: Download pre-built rav1e
        run: |
          curl -fsSL "https://github.com/xiph/rav1e/releases/download/v${RAV1E_VERSION}/librav1e-${RAV1E_VERSION}-macos-aarch64.tar.gz" \
            | sudo tar xz -C /usr/local --strip-components=0

      - name: Build libavif (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_RAV1E=SYSTEM \
            -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_AOM=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF
          cmake --build build -j$(sysctl -n hw.ncpu)
          sudo cmake --install build

      - name: Build renpak
        run: RENPAK_STATIC=1 cargo build --release

      - name: Package
        run: |
          strip target/release/renpak
          tar czf renpak-macos-aarch64.tar.gz -C target/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-macos-aarch64
          path: renpak-macos-aarch64.tar.gz

  build-macos-x86_64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          brew install cmake ninja pkg-config
          rustup target add x86_64-apple-darwin

      - name: Download pre-built rav1e
        run: |
          mkdir -p /tmp/x86_64-deps
          curl -fsSL "https://github.com/xiph/rav1e/releases/download/v${RAV1E_VERSION}/librav1e-${RAV1E_VERSION}-macos.tar.gz" \
            | tar xz -C /tmp/x86_64-deps --strip-components=0

      - name: Build libavif for x86_64 (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_RAV1E=SYSTEM \
            -DCMAKE_PREFIX_PATH=/tmp/x86_64-deps \
            -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_AOM=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF \
            -DCMAKE_INSTALL_PREFIX=/tmp/x86_64-deps
          cmake --build build -j$(sysctl -n hw.ncpu)
          cmake --install build

      - name: Build renpak for x86_64
        env:
          RENPAK_STATIC: "1"
          AVIF_PREFIX: /tmp/x86_64-deps
          RAV1E_PREFIX: /tmp/x86_64-deps
          PKG_CONFIG_PATH: /tmp/x86_64-deps/lib/pkgconfig
        run: cargo build --release --target x86_64-apple-darwin

      - name: Package
        run: |
          strip target/x86_64-apple-darwin/release/renpak
          tar czf renpak-macos-x86_64.tar.gz -C target/x86_64-apple-darwin/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-macos-x86_64
          path: renpak-macos-x86_64.tar.gz

  build-windows-x86_64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download pre-built rav1e
        shell: bash
        run: |
          curl -fsSL "https://github.com/xiph/rav1e/releases/download/v${RAV1E_VERSION}/rav1e-${RAV1E_VERSION}-windows-msvc-sse4.zip" \
            -o /tmp/rav1e.zip
          mkdir -p C:/deps
          unzip /tmp/rav1e.zip -d /tmp/rav1e-extract
          cp -r /tmp/rav1e-extract/rav1e-windows-msvc-sdk/* C:/deps/

      - name: Build libavif (static)
        shell: bash
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /c/libavif
          cd /c/libavif
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_RAV1E=SYSTEM \
            -DCMAKE_PREFIX_PATH=C:/deps \
            -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_AOM=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF \
            -DCMAKE_INSTALL_PREFIX=C:/deps
          cmake --build build --config Release
          cmake --install build

      - name: Build renpak
        shell: bash
        env:
          RENPAK_STATIC: "1"
          AVIF_PREFIX: "C:/deps"
          RAV1E_PREFIX: "C:/deps"
        run: cargo build --release

      - name: Package
        run: Compress-Archive -Path target\release\renpak.exe -DestinationPath renpak-windows-x86_64.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-windows-x86_64
          path: renpak-windows-x86_64.zip

  release:
    needs: [build-linux-x86_64, build-linux-aarch64, build-macos-aarch64, build-macos-x86_64, build-windows-x86_64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            renpak-*.tar.gz
            renpak-*.zip
          generate_release_notes: true
