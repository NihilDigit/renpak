name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  AOM_VERSION: "3.12.1"
  LIBAVIF_VERSION: "1.1.1"

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config nasm

      - name: Build aom (static, encoder only)
        run: |
          git clone --depth 1 --branch v${AOM_VERSION} https://aomedia.googlesource.com/aom /tmp/aom
          cd /tmp/aom
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCONFIG_AV1_ENCODER=1 -DCONFIG_AV1_DECODER=0 \
            -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DENABLE_TOOLS=OFF -DENABLE_DOCS=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig

      - name: Build libavif (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_AOM=SYSTEM -DAVIF_CODEC_AOM_DECODE=OFF \
            -DAVIF_CODEC_RAV1E=OFF -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig

      - name: Build renpak
        run: RENPAK_STATIC=1 cargo build --release

      - name: Package
        run: |
          strip target/release/renpak
          tar czf renpak-linux-x86_64.tar.gz -C target/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-linux-x86_64
          path: renpak-linux-x86_64.tar.gz

  build-linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config

      - name: Build aom (static, encoder only)
        run: |
          git clone --depth 1 --branch v${AOM_VERSION} https://aomedia.googlesource.com/aom /tmp/aom
          cd /tmp/aom
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCONFIG_AV1_ENCODER=1 -DCONFIG_AV1_DECODER=0 \
            -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DENABLE_TOOLS=OFF -DENABLE_DOCS=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig

      - name: Build libavif (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_AOM=SYSTEM -DAVIF_CODEC_AOM_DECODE=OFF \
            -DAVIF_CODEC_RAV1E=OFF -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig

      - name: Build renpak
        run: RENPAK_STATIC=1 cargo build --release

      - name: Package
        run: |
          strip target/release/renpak
          tar czf renpak-linux-aarch64.tar.gz -C target/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-linux-aarch64
          path: renpak-linux-aarch64.tar.gz

  build-macos-aarch64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: brew install cmake ninja pkg-config

      - name: Build aom (static, encoder only)
        run: |
          git clone --depth 1 --branch v${AOM_VERSION} https://aomedia.googlesource.com/aom /tmp/aom
          cd /tmp/aom
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCONFIG_AV1_ENCODER=1 -DCONFIG_AV1_DECODER=0 \
            -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DENABLE_TOOLS=OFF -DENABLE_DOCS=OFF
          cmake --build build -j$(sysctl -n hw.ncpu)
          sudo cmake --install build

      - name: Build libavif (static)
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /tmp/libavif
          cd /tmp/libavif
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_AOM=SYSTEM -DAVIF_CODEC_AOM_DECODE=OFF \
            -DAVIF_CODEC_RAV1E=OFF -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF
          cmake --build build -j$(sysctl -n hw.ncpu)
          sudo cmake --install build

      - name: Build renpak
        run: RENPAK_STATIC=1 cargo build --release

      - name: Package
        run: |
          strip target/release/renpak
          tar czf renpak-macos-aarch64.tar.gz -C target/release renpak

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-macos-aarch64
          path: renpak-macos-aarch64.tar.gz

  build-windows-x86_64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build aom (static, encoder only)
        shell: bash
        run: |
          git clone --depth 1 --branch v${AOM_VERSION} https://aomedia.googlesource.com/aom /c/aom
          cd /c/aom
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCONFIG_AV1_ENCODER=1 -DCONFIG_AV1_DECODER=0 \
            -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DENABLE_TOOLS=OFF -DENABLE_DOCS=OFF \
            -DENABLE_NASM=ON \
            -DCMAKE_INSTALL_PREFIX=C:/deps
          cmake --build build --config Release
          cmake --install build

      - name: Build libavif (static)
        shell: bash
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /c/libavif
          cd /c/libavif
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_AOM=SYSTEM -DAVIF_CODEC_AOM_DECODE=OFF \
            -DCMAKE_PREFIX_PATH=C:/deps \
            -DAVIF_CODEC_RAV1E=OFF -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF \
            -DCMAKE_INSTALL_PREFIX=C:/deps
          cmake --build build --config Release
          cmake --install build

      - name: Build renpak
        shell: bash
        env:
          RENPAK_STATIC: "1"
          AVIF_PREFIX: "C:/deps"
          AOM_PREFIX: "C:/deps"
        run: cargo build --release

      - name: Package
        run: Compress-Archive -Path target\release\renpak.exe -DestinationPath renpak-windows-x86_64.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-windows-x86_64
          path: renpak-windows-x86_64.zip

  build-windows-aarch64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4

      - name: Build aom (static, encoder only)
        shell: bash
        run: |
          git clone --depth 1 --branch v${AOM_VERSION} https://aomedia.googlesource.com/aom /c/aom
          cd /c/aom
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCONFIG_AV1_ENCODER=1 -DCONFIG_AV1_DECODER=0 \
            -DENABLE_TESTS=OFF -DENABLE_EXAMPLES=OFF -DENABLE_TOOLS=OFF -DENABLE_DOCS=OFF \
            -DCMAKE_INSTALL_PREFIX=C:/deps
          cmake --build build --config Release
          cmake --install build

      - name: Build libavif (static)
        shell: bash
        run: |
          git clone --depth 1 --branch v${LIBAVIF_VERSION} https://github.com/AOMediaCodec/libavif /c/libavif
          cd /c/libavif
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DAVIF_CODEC_AOM=SYSTEM -DAVIF_CODEC_AOM_DECODE=OFF \
            -DCMAKE_PREFIX_PATH=C:/deps \
            -DAVIF_CODEC_RAV1E=OFF -DAVIF_CODEC_DAV1D=OFF -DAVIF_CODEC_SVT=OFF \
            -DAVIF_LIBYUV=OFF \
            -DCMAKE_INSTALL_PREFIX=C:/deps
          cmake --build build --config Release
          cmake --install build

      - name: Build renpak
        shell: bash
        env:
          RENPAK_STATIC: "1"
          AVIF_PREFIX: "C:/deps"
          AOM_PREFIX: "C:/deps"
        run: cargo build --release

      - name: Package
        run: Compress-Archive -Path target\release\renpak.exe -DestinationPath renpak-windows-aarch64.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: renpak-windows-aarch64
          path: renpak-windows-aarch64.zip

  release:
    needs: [build-linux-x86_64, build-linux-aarch64, build-macos-aarch64, build-windows-x86_64, build-windows-aarch64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            renpak-*.tar.gz
            renpak-*.zip
          generate_release_notes: true
